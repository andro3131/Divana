---
import { useTranslations, type Locale } from '../../i18n/ui';

interface Props {
  locale: Locale;
  eventId: string;
  remainingCapacity: number;
}

const { locale, eventId, remainingCapacity } = Astro.props;
const t = useTranslations(locale);
---

<form id="reservation-form" class="space-y-5 max-w-lg mx-auto" data-event-id={eventId}>
  <div>
    <label for="res-name" class="block text-sm font-medium text-dark-200 mb-1.5">{t('reservation.name')}</label>
    <input
      type="text"
      id="res-name"
      name="name"
      required
      class="w-full px-4 py-3 bg-dark-800 border border-dark-600 rounded-lg text-dark-50 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition outline-none"
    />
  </div>
  <div>
    <label for="res-email" class="block text-sm font-medium text-dark-200 mb-1.5">{t('reservation.email')}</label>
    <input
      type="email"
      id="res-email"
      name="email"
      required
      class="w-full px-4 py-3 bg-dark-800 border border-dark-600 rounded-lg text-dark-50 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition outline-none"
    />
  </div>
  <div>
    <label for="res-phone" class="block text-sm font-medium text-dark-200 mb-1.5">{t('reservation.phone')}</label>
    <input
      type="tel"
      id="res-phone"
      name="phone"
      required
      class="w-full px-4 py-3 bg-dark-800 border border-dark-600 rounded-lg text-dark-50 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition outline-none"
    />
  </div>
  <div>
    <label for="res-pairs" class="block text-sm font-medium text-dark-200 mb-1.5">{t('reservation.pairs')}</label>
    <input
      type="number"
      id="res-pairs"
      name="numberOfPairs"
      min="1"
      max={remainingCapacity}
      value="1"
      required
      class="w-full px-4 py-3 bg-dark-800 border border-dark-600 rounded-lg text-dark-50 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition outline-none"
    />
  </div>
  <div>
    <label for="res-message" class="block text-sm font-medium text-dark-200 mb-1.5">{t('reservation.message')}</label>
    <textarea
      id="res-message"
      name="message"
      rows="3"
      class="w-full px-4 py-3 bg-dark-800 border border-dark-600 rounded-lg text-dark-50 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition outline-none resize-none"
    ></textarea>
  </div>
  <button
    type="submit"
    class="w-full py-3 px-6 bg-gradient-to-r from-primary-400 to-primary-600 text-dark-950 font-semibold rounded-lg hover:from-primary-300 hover:to-primary-500 transition-all duration-300 transform hover:scale-[1.02] tracking-wider uppercase text-sm"
  >
    {t('reservation.submit')}
  </button>
  <div id="reservation-feedback" class="hidden text-center py-3 rounded-lg text-sm"></div>
</form>

<script>
  const form = document.getElementById('reservation-form') as HTMLFormElement;
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const feedback = document.getElementById('reservation-feedback')!;
    const formData = new FormData(form);
    const data: Record<string, any> = Object.fromEntries(formData);
    data.eventId = form.dataset.eventId!;
    data.numberOfPairs = Number(data.numberOfPairs);

    const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement;
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = '...';

    try {
      const res = await fetch('/api/reservations/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });
      const result = await res.json();
      feedback.classList.remove('hidden');
      if (res.ok) {
        feedback.className = 'text-center py-3 rounded-lg bg-green-900/50 text-green-300 text-sm';
        feedback.textContent = result.message;
        form.reset();
      } else {
        feedback.className = 'text-center py-3 rounded-lg bg-red-900/50 text-red-300 text-sm';
        feedback.textContent = result.error;
      }
    } catch {
      feedback.classList.remove('hidden');
      feedback.className = 'text-center py-3 rounded-lg bg-red-900/50 text-red-300 text-sm';
      feedback.textContent = 'Network error. Please try again.';
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
    }
  });
</script>
