---
import { useTranslations, type Locale } from '../../i18n/ui';

interface Props {
  locale: Locale;
  eventId: string;
  remainingCapacity: number;
  onlinePrice: number;
}

const { locale, eventId, remainingCapacity, onlinePrice } = Astro.props;
const t = useTranslations(locale);
const pairLabel = locale === 'sl' ? 'par' : 'couple';
---

<form id="reservation-form" class="space-y-5 max-w-lg mx-auto" data-event-id={eventId} data-locale={locale}>
  <div>
    <label for="res-name" class="block text-sm font-medium text-dark-200 mb-1.5">{t('reservation.name')}</label>
    <input
      type="text"
      id="res-name"
      name="name"
      required
      class="w-full px-4 py-3 bg-dark-800 border border-dark-600 rounded-lg text-dark-50 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition outline-none"
    />
  </div>
  <div>
    <label for="res-email" class="block text-sm font-medium text-dark-200 mb-1.5">{t('reservation.email')}</label>
    <input
      type="email"
      id="res-email"
      name="email"
      required
      class="w-full px-4 py-3 bg-dark-800 border border-dark-600 rounded-lg text-dark-50 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition outline-none"
    />
  </div>
  <div>
    <label for="res-phone" class="block text-sm font-medium text-dark-200 mb-1.5">{t('reservation.phone')}</label>
    <input
      type="tel"
      id="res-phone"
      name="phone"
      required
      class="w-full px-4 py-3 bg-dark-800 border border-dark-600 rounded-lg text-dark-50 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition outline-none"
    />
  </div>
  <div>
    <label for="res-pairs" class="block text-sm font-medium text-dark-200 mb-1.5">{t('reservation.pairs')}</label>
    <input
      type="number"
      id="res-pairs"
      name="numberOfPairs"
      min="1"
      max={remainingCapacity}
      value="1"
      required
      class="w-full px-4 py-3 bg-dark-800 border border-dark-600 rounded-lg text-dark-50 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition outline-none"
    />
  </div>
  <div>
    <label for="res-message" class="block text-sm font-medium text-dark-200 mb-1.5">{t('reservation.message')}</label>
    <textarea
      id="res-message"
      name="message"
      rows="3"
      class="w-full px-4 py-3 bg-dark-800 border border-dark-600 rounded-lg text-dark-50 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition outline-none resize-none"
    ></textarea>
  </div>

  <div class="pt-2">
    <button
      type="button"
      id="btn-stripe-pay"
      class="w-full py-3.5 px-6 bg-gradient-to-r from-primary-400 to-primary-600 text-dark-950 font-semibold rounded-lg hover:from-primary-300 hover:to-primary-500 transition-all duration-300 transform hover:scale-[1.02] tracking-wider uppercase text-sm flex items-center justify-center gap-2"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/></svg>
      {t('reservation.submitPay')} ({(onlinePrice / 100).toFixed(0)}&euro;/{pairLabel})
    </button>
  </div>

  <div id="reservation-feedback" class="hidden text-center py-3 rounded-lg text-sm"></div>
</form>

<script>
  const form = document.getElementById('reservation-form') as HTMLFormElement;
  const stripeBtn = document.getElementById('btn-stripe-pay')!;
  const feedback = document.getElementById('reservation-feedback')!;

  function getFormData() {
    const formData = new FormData(form);
    const data: Record<string, any> = Object.fromEntries(formData);
    data.eventId = form.dataset.eventId!;
    data.numberOfPairs = Number(data.numberOfPairs);
    data.locale = form.dataset.locale || 'sl';
    return data;
  }

  function showFeedback(type: 'success' | 'error', message: string) {
    feedback.classList.remove('hidden');
    feedback.className = type === 'success'
      ? 'text-center py-3 rounded-lg bg-green-900/50 text-green-300 text-sm'
      : 'text-center py-3 rounded-lg bg-red-900/50 text-red-300 text-sm';
    feedback.textContent = message;
  }

  async function handleStripePayment() {
    if (!form.reportValidity()) return;
    const data = getFormData();
    const originalText = stripeBtn.textContent;
    stripeBtn.setAttribute('disabled', '');
    stripeBtn.textContent = '...';
    try {
      const res = await fetch('/api/checkout/create-session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });
      const result = await res.json();
      if (res.ok && result.url) {
        window.location.href = result.url;
      } else {
        showFeedback('error', result.error || `Error ${res.status}`);
        stripeBtn.removeAttribute('disabled');
        stripeBtn.textContent = originalText;
      }
    } catch (err: any) {
      showFeedback('error', `Network error: ${err.message}`);
      stripeBtn.removeAttribute('disabled');
      stripeBtn.textContent = originalText;
    }
  }

  stripeBtn.addEventListener('click', handleStripePayment);
</script>
