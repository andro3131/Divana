---
export const prerender = false;

import AdminLayout from '../../layouts/AdminLayout.astro';
import { db, Event, Reservation, ContactMessage, eq, sql } from 'astro:db';

const session = Astro.cookies.get('admin-session');
if (!session || session.value !== 'authenticated') {
  return Astro.redirect('/admin/login');
}

// Fetch all events with reservation counts
const events = await db
  .select()
  .from(Event)
  .orderBy(Event.date);

const eventsWithCounts = await Promise.all(
  events.map(async (event) => {
    const reservations = await db
      .select()
      .from(Reservation)
      .where(eq(Reservation.eventId, event.id));

    const activeReservations = reservations.filter((r) => r.status !== 'expired');
    const totalPairs = activeReservations.reduce((sum, r) => sum + r.numberOfPairs, 0);

    return {
      ...event,
      reservationCount: activeReservations.length,
      reservedPairs: totalPairs,
      remainingCapacity: event.capacity - totalPairs,
    };
  })
);

// Recent contact messages
const messages = await db
  .select()
  .from(ContactMessage)
  .orderBy(ContactMessage.createdAt)
  .limit(10);
---

<AdminLayout title="Admin Dashboard - Divana">
  <div class="space-y-10">
    <!-- Events -->
    <div>
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-heading text-gold">Dogodki</h2>
        <a
          href="/admin/events"
          class="px-4 py-2 bg-primary-500 text-dark-950 rounded-lg hover:bg-primary-400 transition text-sm font-medium"
        >
          + Nov dogodek
        </a>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b border-dark-700">
              <th class="text-left py-3 px-4 text-dark-400 font-medium">Naziv</th>
              <th class="text-left py-3 px-4 text-dark-400 font-medium">Datum</th>
              <th class="text-left py-3 px-4 text-dark-400 font-medium">Lokacija</th>
              <th class="text-center py-3 px-4 text-dark-400 font-medium">Rezervacije</th>
              <th class="text-center py-3 px-4 text-dark-400 font-medium">Kapaciteta</th>
              <th class="text-center py-3 px-4 text-dark-400 font-medium">Status</th>
              <th class="text-right py-3 px-4 text-dark-400 font-medium">Akcije</th>
            </tr>
          </thead>
          <tbody>
            {eventsWithCounts.map((event) => (
              <tr class="border-b border-dark-800 hover:bg-dark-800/50 transition-colors">
                <td class="py-3 px-4 text-dark-100">{event.titleSl}</td>
                <td class="py-3 px-4 text-dark-300">
                  {new Intl.DateTimeFormat('sl-SI', { dateStyle: 'medium', timeStyle: 'short' }).format(event.date)}
                </td>
                <td class="py-3 px-4 text-dark-300">{event.location}</td>
                <td class="py-3 px-4 text-center">
                  <span class="text-primary-400">{event.reservedPairs}</span>
                  <span class="text-dark-500"> parov ({event.reservationCount} rez.)</span>
                </td>
                <td class="py-3 px-4 text-center">
                  <span class={event.remainingCapacity <= 0 ? 'text-red-400' : 'text-green-400'}>
                    {event.remainingCapacity}
                  </span>
                  <span class="text-dark-500"> / {event.capacity}</span>
                </td>
                <td class="py-3 px-4 text-center">
                  {event.isPublished ? (
                    <span class="px-2 py-0.5 bg-green-900/50 text-green-400 rounded text-xs">Objavljeno</span>
                  ) : (
                    <span class="px-2 py-0.5 bg-dark-700 text-dark-400 rounded text-xs">Osnutek</span>
                  )}
                </td>
                <td class="py-3 px-4 text-right">
                  <a href={`/admin/events/${event.id}`} class="text-gold hover:text-gold-light transition-colors">
                    Podrobnosti
                  </a>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Recent messages -->
    <div>
      <h2 class="text-2xl font-heading text-gold mb-6">Zadnja sporočila</h2>
      {messages.length === 0 ? (
        <p class="text-dark-400">Ni novih sporočil.</p>
      ) : (
        <div class="space-y-3">
          {messages.reverse().map((msg) => (
            <div class="bg-dark-800/50 border border-dark-700/50 rounded-xl p-4">
              <div class="flex items-center justify-between mb-2">
                <span class="text-dark-100 font-medium">{msg.name}</span>
                <span class="text-dark-500 text-xs">
                  {new Intl.DateTimeFormat('sl-SI', { dateStyle: 'medium', timeStyle: 'short' }).format(msg.createdAt)}
                </span>
              </div>
              <p class="text-dark-400 text-xs mb-1">{msg.email}</p>
              <p class="text-dark-300 text-sm">{msg.message}</p>
            </div>
          ))}
        </div>
      )}
    </div>
  </div>
</AdminLayout>
