---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ReservationForm from '../../components/forms/ReservationForm.astro';
import { db, Event, Reservation, eq, sql } from 'astro:db';
import { useTranslations } from '../../i18n/ui';

export async function getStaticPaths() {
  const events = await db.select().from(Event).where(eq(Event.isPublished, true));
  return events.map((event) => ({
    params: { eventid: event.id },
  }));
}

const { eventid } = Astro.params;
const locale = 'sl' as const;
const t = useTranslations(locale);

const [event] = await db.select().from(Event).where(eq(Event.id, eventid!));
if (!event) {
  return Astro.redirect('/');
}

const [{ totalPairs }] = await db
  .select({ totalPairs: sql<number>`COALESCE(SUM(${Reservation.numberOfPairs}), 0)` })
  .from(Reservation)
  .where(eq(Reservation.eventId, eventid!));

const remaining = event.capacity - totalPairs;

const dateStr = new Intl.DateTimeFormat('sl-SI', {
  dateStyle: 'full',
  timeStyle: 'short',
}).format(event.date);
---

<BaseLayout title={`Rezervacija - ${event.titleSl}`} description={`Rezerviraj mesto za ${event.titleSl}`}>
  <section class="min-h-screen py-28 px-4 bg-dark-900">
    <div class="max-w-2xl mx-auto">
      <a href="/" class="inline-flex items-center text-dark-400 hover:text-gold transition-colors text-sm mb-8">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
        {t('reservation.back')}
      </a>

      <h1 class="text-3xl md:text-4xl font-heading font-semibold text-gold-gradient text-center mb-4">
        {event.titleSl}
      </h1>

      <div class="text-center text-dark-300 mb-10 space-y-1.5">
        <p class="flex items-center justify-center gap-2">
          <svg class="w-4 h-4 text-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
          {dateStr}
        </p>
        <p class="flex items-center justify-center gap-2">
          <svg class="w-4 h-4 text-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
          {event.location}
        </p>
        {event.price && (
          <p class="text-lg font-semibold text-primary-300">{(event.price / 100).toFixed(0)}&euro; na par</p>
        )}
        <p class="text-primary-400 font-semibold mt-2">Å e {remaining} prostih mest</p>
      </div>

      {event.descriptionSl && (
        <p class="text-dark-300 text-center italic mb-10 max-w-lg mx-auto">&ldquo;{event.descriptionSl}&rdquo;</p>
      )}

      {remaining > 0 ? (
        <ReservationForm locale={locale} eventId={eventid!} remainingCapacity={remaining} />
      ) : (
        <p class="text-center text-xl text-red-400 font-semibold">Razprodano</p>
      )}
    </div>
  </section>
</BaseLayout>
